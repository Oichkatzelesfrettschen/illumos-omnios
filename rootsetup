#!/usr/bin/env bash

##
# @file rootsetup
# @brief Install base documentation build dependencies.
#
# This helper installs the minimal packages required for generating
# API documentation.  It also ensures optional dependencies are
# included when available.  The script assumes the user has sudo
# privileges.
##

set -euo pipefail

# Update package lists to fetch the latest versions.
sudo apt-get update -y

# Compose the package list in a single variable to ensure that
# everything installs in one transaction. This minimises package
# database lock contention.
PACKAGES="build-essential doxygen python3-sphinx python3-breathe \
python3-sphinx-rtd-theme cloc qemu-system-x86 qemu-utils"

# Pull in python3-sphinxcontrib when present.
apt-cache show python3-sphinxcontrib >/dev/null 2>&1 && \
    PACKAGES="$PACKAGES python3-sphinxcontrib"

# Choose the optimal tmux flavour.
if apt-cache show tmux-headless >/dev/null 2>&1; then
    PACKAGES="$PACKAGES tmux-headless"
else
    PACKAGES="$PACKAGES tmux"
fi

# Install the complete package set.
sudo apt-get install -y "$PACKAGES"
